# sapemu Emulator Design

This document provides a rough overview of the emulator design and corresponding design decisions.

For context, it is important to note the primary design goal of sapemu: to be as cycle-accurate as feasible. This is a distinguishing feature from most SPC700 emulators (a major exception being Mesen), which are occasionally cycle-accurate in the SMP emulation, but rarely cycle-accurate in the DSP emulation. Cycle-accurate emulation of both parts of the system is important to achieve sample-by-sample accuracy, as imprecise DSP emulation can easily shift the result of a DSP register write forward or backwards one sample (or more, e.g. for KON/KOFF), and imprecise SMP emulation can shift the time when certain state is read from the DSP or timers, further shifting the reaction time to these events.

SMP (the microprocessor) and DSP (the sound engine) execute in lockstep, clocked from the same ~2MHz clock. This clock is also the DAC serial clock, and therefore there are 32 cycles between each sample (16-bit stereo) being output at 32Khz. Furthermore, there are three memory access cycles within each main cycle: one memory access for the SMP and two for the DSP. The DSP accesses its registers and memory data (mostly BRR and echo related) in a deterministic pattern that repeats every sample, i.e. every 32 cycles. (An exception are KON/KOFF, whose access patterns repeat every 2 samples or 64 cycles.) Each SMP instruction takes a certain number of cycles (may vary within branch instructions depending on whether branches are taken or not), with certain memory accesses happening on certain steps of an instruction.

Crucially, memory and register accesses are the only externally visible effect of either DSP or SMP. For cycle-accuracy, it does not matter when the hardware calculations are run in the emulator, it only matters that the calculation uses the correct data that the hardware would use. For instance, for the DSP, all calculations corresponding to a voice are possible to execute at the end of one specific cycle per voice, but the values used in that calculation must be read at the exact points in time as the hardware, and stored for use in this execution later. Similarly, SMP memory accesses must be cycle-accurate, but some cycles do not do anything in the emulator since it’s easier to perform a calculation later or earlier than the hardware would do, given that the reads and writes were executed in the correct cycle. For example, the DIV instruction takes a lot of cycles, but since it never accesses memory beyond the opcode fetch, its calculation is performed in the very last cycle. SMP register state does not have to be cycle-accurate, as it is only visible to the next instruction executed within the SMP.

[Nocash’s SNES hardware documentation](https://problemkaputt.de/fullsnes.htm) has been instrumental in writing the emulator and making it cycle-accurate. To my knowledge, this is the most complete and accurate SPC700 documentation available, especially for the DSP - if you know of anything better, let me know.
